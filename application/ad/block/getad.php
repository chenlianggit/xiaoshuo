<?php
class getadBlock extends Block{ public function run($zym_16) { if (isset($zym_16['key'])){ $zym_15=I('key','en','',$zym_16); $zym_14=M('ad')->field('key')->where(array('key'=>$zym_15))->find(); if ($zym_14){ return '<script type="text/javascript" src="'.PT_DIR . '/public/' . C('addir') . '/' . $zym_14['key'] . '.js"></script>'; }else{ return '没有匹配到对应的广告'; } }elseif (isset($zym_16['width']) && isset($zym_16['height'])){ $zym_17=I('width','int',0,$zym_16); $zym_18=I('height','int',0,$zym_16); $zym_20=I('order','int',0,$zym_16); $zym_13=M('ad')->field('key')->where(array('width'=>$zym_17,'height'=>$zym_18))->order('id asc')->select(); if ($zym_13){ if ($zym_20==0){ return '<script type="text/javascript" src="'.PT_DIR . '/public/' . C('addir') . '/' . $zym_13[array_rand($zym_13)]['key'] . '.js"></script>'; }else{ --$zym_20; if (isset($zym_13[$zym_20])){ return '<script type="text/javascript" src="'.PT_DIR . '/public/' . C('addir') . '/' . $zym_13[$zym_20]['key'] . '.js"></script>'; } } } if ($zym_17 && $zym_18){ $zym_19=$this->createimg($zym_17,$zym_18); return "<img src=\"{$zym_19}\" width=\"{$zym_17}\" height=\"{$zym_18}\" />"; }else{ return ''; } }else{ return '区块参数错误'; } } protected function parseAd($zym_14) { if ($zym_14['type']==1){ return $zym_14['code']; }else{ return '<script type = "text/javascript">'.$zym_14['code'].'</script>'; } } protected function createimg($zym_17,$zym_18){ $zym_19 = PT_ROOT . '/public/' . C('addir') . '/' . $zym_17.'_'.$zym_18 . '.png'; if (!is_file($zym_19)){ F($zym_19,''); $zym_10 = imagecreatetruecolor($zym_17, $zym_18); $zym_6 = imagecolorallocate($zym_10, 255, 255, 255); imagefill($zym_10, 0, 0, $zym_6); $zym_5 = imagecolorallocate($zym_10, 255, 255, 255); $zym_7 = imagecolorallocate($zym_10, 180, 180, 180); $zym_12 = array($zym_7, $zym_7, $zym_7, $zym_7, $zym_7, $zym_5, $zym_5, $zym_5, $zym_5, $zym_5); imagesetstyle($zym_10, $zym_12); imageline($zym_10, 5, 5, $zym_17-6, 5, IMG_COLOR_STYLED); imageline($zym_10, 5, 6, $zym_17-6, 6, IMG_COLOR_STYLED); imageline($zym_10, 5, 7, $zym_17-6, 7, IMG_COLOR_STYLED); imageline($zym_10, 5, $zym_18-5, $zym_17-6, $zym_18-5, IMG_COLOR_STYLED); imageline($zym_10, 5, $zym_18-6, $zym_17-6, $zym_18-6, IMG_COLOR_STYLED); imageline($zym_10, 5, $zym_18-7, $zym_17-6, $zym_18-7, IMG_COLOR_STYLED); imageline($zym_10, 5, 5, 5, $zym_18-6, IMG_COLOR_STYLED); imageline($zym_10, 6, 5, 6, $zym_18-6, IMG_COLOR_STYLED); imageline($zym_10, 7, 5, 7, $zym_18-6, IMG_COLOR_STYLED); imageline($zym_10, $zym_17-5, 5, $zym_17-5, $zym_18-6, IMG_COLOR_STYLED); imageline($zym_10, $zym_17-6, 5, $zym_17-6, $zym_18-6, IMG_COLOR_STYLED); imageline($zym_10, $zym_17-7, 5, $zym_17-7, $zym_18-6, IMG_COLOR_STYLED); imagepng($zym_10,$zym_19); imagedestroy($zym_10); $zym_11=new image($zym_19); $zym_8=min($zym_17/20,$zym_18/4); $zym_9='广告尺寸: '.$zym_17.'*'.$zym_18; if ($zym_8<12){ $zym_8=12; $zym_9=$zym_17.'*'.$zym_18; } $zym_11->text($zym_9,PT_ROOT.'/public/font/'.C('water_font'),$zym_8,'#999999',image::IMAGE_WATER_CENTER); imagepng($zym_11->img,$zym_19); } return PT_DIR.'/public/' . C('addir') . '/' . $zym_17.'_'.$zym_18 . '.png'; } }
?>