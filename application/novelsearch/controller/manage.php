<?php
 class ManageController extends AdminController { public function init() { $this->tableName = 'novelsearch_info'; parent::init(); } public function indexAction() { $zym_13 = $this->_parsemap(); $this->view->page = I('request.page', 'int', 1); $this->view->pagesize = C('admin_pagesie', null, 20); $zym_12 = (array)$this->model->field('id,pinyin,categoryid,name,author,lastchaptername,lastupdate,status')->where($zym_13)->page($this->page)->limit($this->pagesize)->order('lastupdate desc')->select(); $this->view->totalnum = $this->model->where($zym_13)->count(); $this->view->pagenum = ceil($this->totalnum / $this->pagesize); foreach ($zym_12 as &$zym_15) { $zym_15['lastupdate'] = date('Y-m-d H:i:s', $zym_15['lastupdate']); $zym_15['url_edit'] = U('novelsearch.manage.edit', array('id' => $zym_15['id'])); $zym_15['url_info'] = U('novelsearch.novel.index', array('novelid' => $zym_15['id'], 'novelkey' => $zym_15['pinyin'])); $zym_15['url_chapterlist'] = U('novelsearch.chapter.list', array('novelid' => $zym_15['id'], 'novelkey' => $zym_15['pinyin'])); $zym_15['url_category'] = dc::get('category', $zym_15['categoryid'], 'url'); $zym_15['category'] = dc::get('category', $zym_15['categoryid'], 'name'); $zym_11=(new AuthorModel())->field('id,pinyin')->where(['name'=>$zym_15['author']])->find(); if($zym_11){ $zym_15['url_author'] = U('novelsearch.novel.author', array('author' => urlencode($zym_15['author']),'authorid'=>$zym_11['id'],'authorpinyin'=>$zym_11['pinyin'])); }else{ $zym_15['url_author'] = "#"; } } $this->view->list = $zym_12; if (IS_AJAX) { $this->ajax(array('data' => $this->list, 'totalnum' => $this->totalnum, 'pagenum' => $this->pagenum)); } else { $this->display(); } } public function indexmoreAction() { $zym_16 = [ 'siteid' => $this->input->get('siteid', 'int', 0), 'searchtype' => $this->input->get("searchtype", ['name', 'author','id'], 'name'), 'searchkey' => $this->filter->safeStrip($this->input->get("searchkey", 'str', '')), 'status' => $this->input->get('status', 'int', 0), 'isover' => $this->input->get('status', 'int', 0), 'categoryid' => $this->input->get('categoryid', 'int', 0), 'sort' => $this->input->get('sort', ['lastupdate', 'id', 'allvisit', 'monthvisit', 'weekvisit', 'dayvisit', 'marknum'], 'id'), 'order' => $this->input->get('order', ['desc', 'asc'], 'desc'), 'starttime' => $this->input->get('starttime', 'str', ''), 'endtime' => $this->input->get('endtime', 'str', ''), ]; $zym_13 = []; if ($zym_16['starttime'] && $zym_16['endtime']) { $zym_13['postdate'] = ['between', [strtotime($zym_16['starttime']), strtotime($zym_16['endtime'])]]; } if ($zym_16['status']) { $zym_13['status'] = $zym_16['status'] - 1; } if ($zym_16['categoryid']) { $zym_13['categoryid'] = $zym_16['categoryid']; } if ($zym_16['searchkey']) { if($zym_16['searchtype']=='id'){ $zym_13[$zym_16['searchtype']] = $zym_16['searchkey']; }else{ $zym_13[$zym_16['searchtype']] = array('like', '%' . $zym_16['searchkey'] . '%'); } } if($zym_16['siteid']){ $zym_13['siteid'] = $zym_16['siteid']; } if($zym_16['isover']){ $zym_13['isover'] = $zym_16['isover']-1; } $this->view->status = $zym_16['status']; $this->view->categoryid = $zym_16['categoryid']; $this->view->searchtype = $zym_16['searchtype']; $this->view->searchkey = $zym_16['searchkey']; $this->view->sort = $zym_16['sort']; $this->view->order = $zym_16['order']; $this->view->starttime = $zym_16['starttime']; $this->view->endtime = $zym_16['endtime']; $this->view->page = $this->input->get('page', 'int', 1); $this->view->pagesize = C('admin_pagesie', null, 20); $this->view->sitelist = (new NovelSearch_SiteModel())->field('id,name')->where(['status' => 1])->select(); $this->view->totalnum = $this->model->where($zym_13)->count(); $this->view->pagenum = ceil($this->totalnum / $this->pagesize); $zym_12 = (array)$this->model->field('id,pinyin,siteid,categoryid,name,author,isover,lastchaptername,lastupdate,status,intro,cover,postdate')->where($zym_13)->page($this->view->page)->limit($this->view->pagesize)->order($zym_16['sort'] . ' ' . $zym_16['order'])->select(); foreach ($zym_12 as &$zym_15) { $zym_15['url_edit'] = U('novelsearch.manage.edit', array('id' => $zym_15['id'])); $zym_15['url_info'] = U('novelsearch.novel.index', array('novelid' => $zym_15['id'], 'novelkey' => $zym_15['pinyin'])); $zym_15['url_chapterlist'] = U('novelsearch.chapter.list', array('novelid' => $zym_15['id'], 'novelkey' => $zym_15['pinyin'])); $zym_15['url_category'] = dc::get('category', $zym_15['categoryid'], 'url'); $zym_15['category'] = dc::get('category', $zym_15['categoryid'], 'name'); $zym_15['sitename'] = $zym_15['siteid'] > 0 ? dc::get('novelsearch_site', $zym_15['siteid'], 'name') : '本站原创'; $zym_11=(new AuthorModel())->field('id,pinyin')->where(['name'=>$zym_15['author']])->find(); if($zym_11){ $zym_15['url_author'] = U('novelsearch.novel.author', array('author' => urlencode($zym_15['author']),'authorid'=>$zym_11['id'],'authorpinyin'=>$zym_11['pinyin'])); }else{ $zym_15['url_author'] = "#"; } } $zym_16['page'] = '__PAGE__'; $this->view->pageurl = U('novelsearch.manage.indexmore', $zym_16); $this->view->list = $zym_12; $this->cookie->set('admin_backurl',__SELF__); $this->display(); } public function editAction() { $zym_17 = I('request.id'); if ($zym_17 && $zym_14 = $this->model->find($zym_17)) { if (IS_POST) { $zym_16 = $_POST; $zym_16['postdate'] = strtotime($zym_16['postdate']); $zym_16['lastupdate'] = strtotime($zym_16['lastupdate']); $zym_16['initial'] = $zym_16['pinyin']{0}; if ($this->model->edit($zym_16)) { dc::rm('novelsearch_info', $zym_17); $zym_8=$this->cookie->get('admin_backurl',__SELF__); $this->success('修改成功',$zym_8?$zym_8:__SELF__); } else { $this->error('修改失败'); } } $this->view->categorylist = M('category')->where(array('pid' => 0))->field('id,name')->select(); $this->view->goodlist = array( '0' => '不推荐', '1' => '推荐一', '2' => '推荐二', ); $this->view->info = $zym_14; $this->display(); } else { $this->error('找不到指定的书'); } } public function ajaxAction() { $zym_17 = I('request.id', 'int', 0); $zym_5 = I('param', 'en', ''); $zym_6 = $this->model->where(array('pinyin' => $zym_5))->field('id')->getField('id'); if ($zym_6 && $zym_6 != $zym_17) { $zym_10 = array('status' => 'n', 'info' => '您输入的拼音已经使用过了'); } else { $zym_10 = array('status' => 'y', 'info' => '您输入的拼音可以使用'); } $this->ajax($zym_10); } public function chapterbanAction() { if ($this->request->isPost()) { $zym_9 = $this->input->post('novelid'); $zym_7 = $this->input->post('chapterids', 'str', ''); M('novelsearch_chapter')->ban($zym_9, $zym_7); $this->success('操作成功，当页面缓存过期后可看效果'); } $this->display(); } public function clearallAction() { if($this->request->isPost()){ $this->model->query('
TRUNCATE `ptcms_author`;
TRUNCATE `ptcms_novelsearch_chapter_0`;
TRUNCATE `ptcms_novelsearch_chapter_1`;
TRUNCATE `ptcms_novelsearch_chapter_2`;
TRUNCATE `ptcms_novelsearch_chapter_3`;
TRUNCATE `ptcms_novelsearch_chapter_4`;
TRUNCATE `ptcms_novelsearch_chapter_5`;
TRUNCATE `ptcms_novelsearch_chapter_6`;
TRUNCATE `ptcms_novelsearch_chapter_7`;
TRUNCATE `ptcms_novelsearch_chapter_8`;
TRUNCATE `ptcms_novelsearch_chapter_9`;
TRUNCATE `ptcms_novelsearch_chapter_10`;
TRUNCATE `ptcms_novelsearch_chapter_11`;
TRUNCATE `ptcms_novelsearch_chapter_12`;
TRUNCATE `ptcms_novelsearch_chapter_13`;
TRUNCATE `ptcms_novelsearch_chapter_14`;
TRUNCATE `ptcms_novelsearch_chapter_15`;
TRUNCATE `ptcms_novelsearch_chapter_16`;
TRUNCATE `ptcms_novelsearch_chapter_17`;
TRUNCATE `ptcms_novelsearch_chapter_18`;
TRUNCATE `ptcms_novelsearch_chapter_19`;
TRUNCATE `ptcms_novelsearch_chapter_20`;
TRUNCATE `ptcms_novelsearch_chapter_21`;
TRUNCATE `ptcms_novelsearch_chapter_22`;
TRUNCATE `ptcms_novelsearch_chapter_23`;
TRUNCATE `ptcms_novelsearch_chapter_24`;
TRUNCATE `ptcms_novelsearch_chapter_25`;
TRUNCATE `ptcms_novelsearch_chapter_26`;
TRUNCATE `ptcms_novelsearch_chapter_27`;
TRUNCATE `ptcms_novelsearch_chapter_28`;
TRUNCATE `ptcms_novelsearch_chapter_29`;
TRUNCATE `ptcms_novelsearch_chapter_30`;
TRUNCATE `ptcms_novelsearch_chapter_31`;
TRUNCATE `ptcms_novelsearch_chapter_32`;
TRUNCATE `ptcms_novelsearch_chapter_33`;
TRUNCATE `ptcms_novelsearch_chapter_34`;
TRUNCATE `ptcms_novelsearch_chapter_35`;
TRUNCATE `ptcms_novelsearch_chapter_36`;
TRUNCATE `ptcms_novelsearch_chapter_37`;
TRUNCATE `ptcms_novelsearch_chapter_38`;
TRUNCATE `ptcms_novelsearch_chapter_39`;
TRUNCATE `ptcms_novelsearch_chapter_40`;
TRUNCATE `ptcms_novelsearch_chapter_41`;
TRUNCATE `ptcms_novelsearch_chapter_42`;
TRUNCATE `ptcms_novelsearch_chapter_43`;
TRUNCATE `ptcms_novelsearch_chapter_44`;
TRUNCATE `ptcms_novelsearch_chapter_45`;
TRUNCATE `ptcms_novelsearch_chapter_46`;
TRUNCATE `ptcms_novelsearch_chapter_47`;
TRUNCATE `ptcms_novelsearch_chapter_48`;
TRUNCATE `ptcms_novelsearch_chapter_49`;
TRUNCATE `ptcms_novelsearch_chapter_50`;
TRUNCATE `ptcms_novelsearch_chapter_51`;
TRUNCATE `ptcms_novelsearch_chapter_52`;
TRUNCATE `ptcms_novelsearch_chapter_53`;
TRUNCATE `ptcms_novelsearch_chapter_54`;
TRUNCATE `ptcms_novelsearch_chapter_55`;
TRUNCATE `ptcms_novelsearch_chapter_56`;
TRUNCATE `ptcms_novelsearch_chapter_57`;
TRUNCATE `ptcms_novelsearch_chapter_58`;
TRUNCATE `ptcms_novelsearch_chapter_59`;
TRUNCATE `ptcms_novelsearch_chapter_60`;
TRUNCATE `ptcms_novelsearch_chapter_61`;
TRUNCATE `ptcms_novelsearch_chapter_62`;
TRUNCATE `ptcms_novelsearch_chapter_63`;
TRUNCATE `ptcms_novelsearch_chapter_64`;
TRUNCATE `ptcms_novelsearch_chapter_65`;
TRUNCATE `ptcms_novelsearch_chapter_66`;
TRUNCATE `ptcms_novelsearch_chapter_67`;
TRUNCATE `ptcms_novelsearch_chapter_68`;
TRUNCATE `ptcms_novelsearch_chapter_69`;
TRUNCATE `ptcms_novelsearch_chapter_70`;
TRUNCATE `ptcms_novelsearch_chapter_71`;
TRUNCATE `ptcms_novelsearch_chapter_72`;
TRUNCATE `ptcms_novelsearch_chapter_73`;
TRUNCATE `ptcms_novelsearch_chapter_74`;
TRUNCATE `ptcms_novelsearch_chapter_75`;
TRUNCATE `ptcms_novelsearch_chapter_76`;
TRUNCATE `ptcms_novelsearch_chapter_77`;
TRUNCATE `ptcms_novelsearch_chapter_78`;
TRUNCATE `ptcms_novelsearch_chapter_79`;
TRUNCATE `ptcms_novelsearch_chapter_80`;
TRUNCATE `ptcms_novelsearch_chapter_81`;
TRUNCATE `ptcms_novelsearch_chapter_82`;
TRUNCATE `ptcms_novelsearch_chapter_83`;
TRUNCATE `ptcms_novelsearch_chapter_84`;
TRUNCATE `ptcms_novelsearch_chapter_85`;
TRUNCATE `ptcms_novelsearch_chapter_86`;
TRUNCATE `ptcms_novelsearch_chapter_87`;
TRUNCATE `ptcms_novelsearch_chapter_88`;
TRUNCATE `ptcms_novelsearch_chapter_89`;
TRUNCATE `ptcms_novelsearch_chapter_90`;
TRUNCATE `ptcms_novelsearch_chapter_91`;
TRUNCATE `ptcms_novelsearch_chapter_92`;
TRUNCATE `ptcms_novelsearch_chapter_93`;
TRUNCATE `ptcms_novelsearch_chapter_94`;
TRUNCATE `ptcms_novelsearch_chapter_95`;
TRUNCATE `ptcms_novelsearch_chapter_96`;
TRUNCATE `ptcms_novelsearch_chapter_97`;
TRUNCATE `ptcms_novelsearch_chapter_98`;
TRUNCATE `ptcms_novelsearch_chapter_99`;
TRUNCATE `ptcms_novelsearch_info`;
TRUNCATE `ptcms_user_mark`;
TRUNCATE `ptcms_novelsearch_log`;'); $this->success('操作成功'); }else{ $this->display(); } } }
?>