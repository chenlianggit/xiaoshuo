<?php
 class PublicController extends CommonController { public function init() { parent::init(); session_start(); $this->defaulturl=U('user.mark.index'); $zym_13 = isset($_REQUEST['comeurl']) ? $_REQUEST['comeurl'] : ((empty($_SERVER['HTTP_REFERER']) || stripos($_SERVER['HTTP_REFERER'],'login')!==false || stripos($_SERVER['HTTP_REFERER'],'register')!==false ) ? $this->defaulturl: $_SERVER['HTTP_REFERER']); if (strpos($zym_13, 'login') !== false || strpos($zym_13, 'register') !== false) { $zym_13 = I('cookie.comeurl', 'str', PT_DIR . '/'); } else { cookie('comeurl', $zym_13, 600); } $this->comeurl = $zym_13; if(!empty($_SESSION['verify'])) unset($_SESSION['verify']); } public function registerAction() { if(IS_LOGIN){ $this->redirect($this->defaulturl); } if (IS_POST){ $zym_14=I('username','username',''); $zym_15=I('password','str',''); $zym_16=I('password1','str',''); $zym_12 = I('post.verify','str',''); if (!empty($_SESSION['verify']) && $zym_12 != $_SESSION['verify']) { $this->error('验证码输入不正确'); } if (!$zym_14){ $this->error('用户名格式不正确'); } if ($zym_15!=$zym_16){ $this->error('两次密码输入不一致'); } if(!$zym_15){ $this->error('密码不能为空'); } $zym_18=M('user')->add($zym_14,$zym_15); if (is_numeric($zym_18)){ $this->success('注册成功',$this->comeurl); }else{ $this->error($zym_18); } } $this->display('register'); } public function loginAction() { if(IS_LOGIN){ $this->redirect($this->defaulturl); } if (IS_POST) { $zym_14 = I('post.username', 'username', ''); $zym_15 = I('post.password', 'str', ''); $zym_12 = I('post.verify'); if (!empty($_SESSION['verify']) && $zym_12 != $_SESSION['verify']) { $this->error('验证码输入不正确'); } if (!$zym_14){ $this->error('用户名格式不正确'); } if(!$zym_15){ $this->error('密码不能为空'); } if ($zym_17=M('user')->checkInfo($zym_14,$zym_15)){ if ($zym_17['status']){ M('user')->setLoginStatus($zym_17); $this->success('登录成功',$this->comeurl); }else{ $this->error('您帐号已经被禁用了'); } }else{ $this->error('登录失败，您帐号或者密码错误'); } } $this->display('login'); } public function logoutAction() { M('user')->delLoginStatus(); $this->success('您已经成功退出系统',C('siteurl')); } public function verifyAction() { verify::buildImageVerify(6, 1, 'png', 70, 28); } public function thirdloginAction() { $zym_10=I('request.type','str',''); if (IS_POST){ $zym_14 = I('post.username', 'username', ''); $zym_15 = I('post.password', 'str', ''); $zym_6 = I('post.openid', 'str', ''); $zym_17=M('user')->field('id,password,salt,qqid,weiboid')->where(array('name'=>$zym_14))->find(); if ($zym_17){ if(md5(md5($zym_15).$zym_17['salt'])==$zym_17['password']){ if ($zym_17[$zym_10 . 'id']){ $this->error('该帐号已经绑定过其他账号',U('user.public.login')); }else{ M('user')->edit(array($zym_10 . 'id' => $zym_6,'id' => $zym_17['id'])); M('user')->setloginstatus($zym_17); $this->success('绑定成功',$this->comeurl); } }else{ $this->error('您输入的帐号或者密码不正确',U('user.public.login')); } }else{ $zym_18=M('user')->add($zym_14,$zym_15); M('user')->edit(array($zym_10 . 'id' => $zym_6,'id' => $zym_18)); M('user')->setloginstatus(dc::get('user',$zym_18)); $this->success('注册并绑定成功',$this->comeurl); } } $zym_10=in_array($zym_10,array('qq','weibo','weixin'))?$zym_10:'qq'; $zym_5=$this->config->get('siteurl').U('user.public.thirdlogin',array('type'=>$zym_10)); if (empty($_GET['code'])){ $zym_7 = oauth::getInstance($zym_10)->authorize($zym_5); $this->redirect($zym_7); }else{ $zym_11=I('get.code','str',''); $zym_8=oauth::getInstance($zym_10); $zym_9=$zym_8->getAccessToken($zym_11,$zym_5); if (!is_array($zym_9)) $this->error($zym_9,U('user.public.login')); if ($zym_17=M('user')->checkopenid($zym_9['openid'],$zym_10)){ M('user')->setLoginStatus($zym_17); $this->success('登陆成功！',$this->comeurl); }else{ $this->openid=$zym_9['openid']; $this->info=$zym_8->getinfo(); $this->thirdtype=$zym_10; $this->display('thirdlogin'); } } } }
?>