<?php
 class Admin_NodeModel extends Model { protected $moduleId = '30'; protected $moduleTopId = '41'; public function add($zym_20) { return $this->insert($zym_20); } public function edit($zym_20) { return $this->update($zym_20); } public function del($zym_19) { return $this->where($zym_19)->delete(); } public function getMenuInfo() { $zym_22 = $this->field('id,name,pid')->where(array('module' => MODULE_NAME, 'controller' => CONTROLLER_NAME, 'action' => ACTION_NAME))->find(); $zym_10 = $this->field('name,pid,module,controller,action')->where(array('id' => $zym_22['pid']))->find(); if (empty($zym_10['module'])) { $zym_23['menu']['name'] = $zym_22['name']; $zym_23['menu']['url'] = U(MODULE_NAME . '.' . CONTROLLER_NAME . '.' . ACTION_NAME); $zym_23['submenu']['name'] = ''; $zym_23['submenu']['url'] = ''; } else { $zym_23['menu']['name'] = $zym_10['name']; $zym_23['menu']['url'] = U($zym_10['module'] . '.' . $zym_10['controller'] . '.' . $zym_10['action']); $zym_23['submenu']['name'] = $zym_22['name']; $zym_23['submenu']['url'] = U(MODULE_NAME . '.' . CONTROLLER_NAME . '.' . ACTION_NAME); } $zym_23['nodeid'] = $zym_22['id']; return $zym_23; } public function getParentList($zym_24) { $zym_22 = $this->where(array('id' => $zym_24))->field('id,pid')->find(); if ($zym_22['pid'] == 0) return array(); $zym_23[] = $zym_22['pid']; $zym_23 = array_merge($zym_23, $this->getParentList($zym_22['pid'])); return $zym_23; } public function toNodeAuth($zym_8) { foreach ($zym_8 as $zym_18) { $zym_5 = $this->getParentList($zym_18); foreach ($zym_5 as $zym_24) { if (!in_array($zym_24, $zym_8)) $zym_8[] = $zym_24; } } return $zym_8; } public function install($zym_21, $zym_9, $zym_7) { if ($zym_9 == '') { $zym_13=$zym_6 = $this->moduleTopId; } else { $zym_20['name']=$zym_9; $zym_20['pid']=$this->moduleId; $zym_20['module']=''; $zym_20['controller']=''; $zym_20['action']=''; $zym_20['status']=1; $zym_20['ordernum']=50; $zym_20['create_user_id']=$_SESSION['admin']['userid']; $zym_20['create_time']=NOW_TIME; $zym_13=$zym_6=$this->add($zym_20); } $zym_17 = $this->parseNodeConfig($zym_21); foreach($zym_17 as $zym_18){ foreach($zym_18 as $zym_14=>$zym_20){ $zym_20['status']=1; $zym_20['ordernum']=50; $zym_20['create_user_id']=$_SESSION['admin']['userid']; $zym_20['create_time']=NOW_TIME; $zym_20['module']=$zym_7; if ($zym_14==0){ $zym_20['pid']=$zym_6; $zym_13=$this->add($zym_20); }else{ $zym_20['pid']=$zym_13; $this->add($zym_20); } } } return true; } public function uninstall($zym_21, $zym_9, $zym_7) { if ($zym_9!=''){ $this->del(array('name'=>$zym_9,'pid'=>$this->moduleId)); } $zym_17 = $this->parseNodeConfig($zym_21); foreach($zym_17 as $zym_18){ foreach($zym_18 as $zym_16){ $zym_16['module']=$zym_7; $this->del($zym_16); } } return true; } public function parseNodeConfig($zym_21) { $zym_8 = explode("\n", trim($zym_21)); $zym_17 = array(); foreach ($zym_8 as $zym_11=>$zym_18) { $zym_15 = explode('|', trim($zym_18)); foreach ($zym_15 as $zym_16) { $zym_12 = explode(':', trim($zym_16)); if (count($zym_12) == 3) { $zym_17[$zym_11][] = array( 'name' => $zym_12['0'], 'controller' => $zym_12['1'], 'action' => $zym_12['2'], ); } } } return $zym_17; } }
?>