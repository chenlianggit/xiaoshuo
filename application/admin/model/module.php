<?php
class ModuleModel extends Model{ public function add($zym_12) { $zym_10=$this->insert($zym_12); $this->updateconfig(); return $zym_10; } public function edit($zym_12) { $zym_10=$this->update($zym_12); $this->updateconfig(); return $zym_10; } public function del($zym_15) { $this->where($zym_15)->delete(); $this->updateconfig(); } public function getlist() { $zym_9 = opendir(APP_PATH); $zym_17 = array(); $zym_5=$this->getfield('key,name,id,system,status,create_user_id,create_time',true); while ($zym_6 = readdir($zym_9)) { $zym_16 = APP_PATH . '/' . $zym_6; if ($zym_6 != '.' && $zym_6 != '..' && $zym_6 != 'common' && $zym_6 != 'admin' && is_dir($zym_16)) { $zym_14 = $zym_16 . '/config.ini'; if (is_file($zym_14)) { $zym_13 = parse_ini_file($zym_14, true); $zym_17[$zym_6] = $zym_13; if (isset($zym_5[$zym_6])){ $zym_17[$zym_6]['issetup']=($zym_5[$zym_6]['system']==1)?2:1; $zym_17[$zym_6]['status']=$zym_5[$zym_6]['status']; $zym_17[$zym_6]['id']=$zym_5[$zym_6]['id']; $zym_17[$zym_6]['create_username']=dc::get('user',$zym_5[$zym_6]['create_user_id'],'name'); $zym_17[$zym_6]['create_time']=$zym_5[$zym_6]['create_time']?date('Y-m-d H:i',$zym_5[$zym_6]['create_time']):''; }else{ $zym_17[$zym_6]['issetup']=0; $zym_17[$zym_6]['status']=-1; $zym_17[$zym_6]['id']=0; $zym_17[$zym_6]['create_username']=''; $zym_17[$zym_6]['create_time']=''; } $zym_17[$zym_6]['key']=$zym_6; $zym_17[$zym_6]['url_install']=U('admin.module.install',array('key'=>$zym_6)); $zym_17[$zym_6]['url_uninstall']=U('admin.module.uninstall',array('key'=>$zym_6)); $zym_17[$zym_6]['url_config']=U('admin.module.config',array('module'=>$zym_6)); unset($zym_17[$zym_6]['nodelist'],$zym_17[$zym_6]['installsql'],$zym_17[$zym_6]['unstallsql'],$zym_17[$zym_6]['nodegroup']); } } } return $zym_17; } public function updateconfig() { $zym_7=$this->where(array('status'=>1))->getField('key',true); M('config')->where(array('key'=>'allow_module'))->edit(array('value'=>implode(',',$zym_7))); $zym_17=$this->where(array('status'=>1))->field('key,name')->select(); foreach($zym_17 as $zym_11){ $zym_8[$zym_11['key']]=$zym_11['name']; } M('config')->where(array('key'=>'default_module'))->edit(array('extra'=>json_encode($zym_8))); } }
?>